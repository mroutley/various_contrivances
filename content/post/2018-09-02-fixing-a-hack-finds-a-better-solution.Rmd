---
title: Fixing a hack finds a better solution
author: Matthew Routley
date: '2018-09-02'
slug: fixing-a-hack-finds-a-better-solution
categories:
  - code
  - election
tags: []
---

```{r setup, include=FALSE}
library(tidyverse)
library(magrittr)
```

In my [Elections Ontario official results](https://matt.routleynet.org/post/elections-ontario-official-results/) post, I had to use an ugly hack to match Electoral District names and numbers by extracting data from a drop down list on the Find My Electoral District website. Although it was mildly clever, like any hack, I shouldn't have relied on this one for long, as proven by Elections Ontario shutting down the website. 

So, a more robust solution was required, which led to using one of Election Ontario's shapefiles. The shapefile contains the data we need, it's just in a tricky format to deal with. But, the `sf` package makes this mostly straightforward.

We start by downloading and importing the Elections Ontario shape file. Then, since we're only interested in the City of Toronto boundaries, we download the city's shapefile too and intersect it with the provincial one to get a subset:

```{r download, echo=TRUE, results='hide', message=FALSE, warning=FALSE}
download.file("https://www.elections.on.ca/content/dam/NGW/sitecontent/2016/preo/shapefiles/Polling%20Division%20Shapefile%20-%202014%20General%20Election.zip", 
              destfile = "data-raw/Polling%20Division%20Shapefile%20-%202014%20General%20Election.zip")
unzip("data-raw/Polling%20Division%20Shapefile%20-%202014%20General%20Election.zip", 
      exdir = "data-raw/Polling%20Division%20Shapefile%20-%202014%20General%20Election")

prov_geo <- sf::st_read("data-raw/Polling%20Division%20Shapefile%20-%202014%20General%20Election", 
                        layer = "PDs_Ontario") %>%
  sf::st_transform(crs = "+init=epsg:4326")

download.file("http://opendata.toronto.ca/gcc/voting_location_2014_wgs84.zip",
              destfile = "data-raw/voting_location_2014_wgs84.zip")
unzip("data-raw/voting_location_2014_wgs84.zip", exdir="data-raw/voting_location_2014_wgs84")
toronto_wards <- sf::st_read("data-raw/voting_location_2014_wgs84", layer = "VOTING_LOCATION_2014_WGS84") %>%
  sf::st_transform(crs = "+init=epsg:4326")

to_prov_geo <- prov_geo %>%
  sf::st_intersection(toronto_wards)
```

Now we just need to extract a couple of columns from the data frame associated with the shapefile. Then we process the values a bit so that they match the format of other data sets. This includes converting them to UTF-8, formatting as title case, and replacing dashes with spaces:

```{r process, echo=TRUE}
electoral_districts <- to_prov_geo %>%
  dplyr::transmute(electoral_district = as.character(DATA_COMPI),
                   electoral_district_name = stringr::str_to_title(KPI04)) %>%
  dplyr::group_by(electoral_district, electoral_district_name) %>%
  dplyr::count() %>%
  dplyr::ungroup() %>%
  dplyr::mutate(electoral_district_name = stringr::str_replace_all(utf8::as_utf8(electoral_district_name), "\u0097", " ")) %>%
  dplyr::select(electoral_district, electoral_district_name)
electoral_districts
```

In the end, this is a much more reliable solution, though it seems a bit extreme to use GIS techniques just to get a listing of Electoral District names and numbers. 

The commit with most of these changes in [toVotes](https://github.com/Psepho/toVotes) is [here](https://github.com/Psepho/toVotes/commit/272ea413a6a9a11f0070bcc2c65ed2fcba6e5a4c). 
